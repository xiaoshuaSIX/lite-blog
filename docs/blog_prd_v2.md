# 博客网站产品需求文档（PRD V2.0 - Consolidated）

## 1. 产品概述
本博客系统提供文章阅读、会员付费、评论互动、角色权限控制、深色模式切换等功能，并包含后台管理系统（文章、用户、权限、可见性、评论管理）。  
支持邮箱注册及验证，未验证邮箱的用户无法发表评论等需要可信身份的操作。

---

## 2. 产品目标
- 提供良好的内容阅读与互动体验  
- 通过会员体系实现内容服务能力  
- 通过可见性与预览算法实现灵活的内容访问策略  
- 提供安全的邮箱注册与验证机制  
- 提供完善的后台管理能力（文章、用户、角色与权限）  
- 支持深色模式提升可读性  

---

## 3. 角色定义与权限

### 3.1 角色列表
| 角色 | 描述 |
|------|------|
| 游客 | 无需登录，仅可阅读预览内容 |
| 用户 | 注册登录用户，需邮箱验证后才能互动 |
| 会员 | 付费未过期用户，可阅读全部内容 |
| 管理员 | 拥有后台权限，可管理所有资源 |

### 3.2 权限矩阵
| 功能 | 游客 | 用户（未验证） | 用户（已验证） | 会员 | 管理员 |
|------|------|---------------|----------------|--------|---------|
| 阅读文章 | 预览 | 预览 | 预览 | 全文 | 全文 |
| 评论 | × | × | ✔ | ✔ | ✔ |
| 后台访问 | × | × | × | × | ✔ |
| 深色模式 | ✔ | ✔ | ✔ | ✔ | ✔ |

---

## 4. 登录 / 注册 / 邮箱验证

### 4.1 注册流程
1. 用户输入邮箱 + 密码  
2. 邮箱必须唯一  
3. 系统创建用户并设置：  
```
email_verified = false  
email_verification_token = <随机值>  
```
4. 发送验证邮件  
5. 用户访问验证链接后，状态更新为：  
```
email_verified = true  
email_verification_date = now  
```

### 4.2 权限限制（邮箱未验证）
| 功能 | 限制原因 |
|------|----------|
| 发表评论 | 必须验证邮箱 |
| 点赞/收藏（未来扩展） | 必须验证邮箱 |

### 4.3 用户中心新增内容
- 显示邮箱验证状态  
- 未验证提供“重新发送验证邮件”按钮  

---

## 5. 前台（客户端）功能

### 5.1 首页（文章列表）
- 展示：标题、作者、发布时间、摘要  
- 支持分页  
- 隐藏文章不显示  

### 5.2 文章详情
- 展示标题、作者、发布时间、正文  
- 根据角色展示预览或全文  
- 预览模式下显示 CTA（成为会员查看全文）  
- 隐藏文章前台不可访问  

### 5.3 文章预览混合算法（核心）
管理员可设置：

```
预览比例（percentage）：0–90%（默认 30%）  
最少展示字数（min_chars）：默认 200  
智能段落截断（smart_paragraph）：默认开启
```

预览内容生成方式：

1. **百分比截取**
```
base_chars = content_length * percentage
```
2. **字数下限**
```
preview_chars = max(base_chars, min_chars)
```
3. **智能段落截断**
- 按段落切分  
- 找到最接近 preview_chars 的段落边界  
- 以完整段落结尾  

### 5.4 评论功能
- 登录且邮箱验证的用户才能评论  
- 评论字数：1–500  
- 评论列表按时间倒序  

### 5.5 深色模式切换
- 支持三种模式：浅色 / 深色 / 跟随系统  
- 可从导航栏切换  
- 本地持久化存储用户偏好（localStorage 或用户设置）  
- 后台同样适配深色模式  

---

## 6. 后台管理系统功能

### 6.1 登录
- 仅管理员可登录  

### 6.2 文章管理
- 新建、编辑、删除文章  
- 设置可见性：  
| 可见性 | 游客 | 用户 | 会员 | 管理员 |
|--------|--------|--------|--------|-----------|
| 隐藏 | × | × | × | ✔ |
| 全部可见 | ✔ | ✔ | ✔ | ✔ |
| 会员可见全文 | 预览 | 预览 | 全文 | 全文 |

- 设置文章预览策略（比例、最少字数、智能段落）

### 6.3 用户管理
管理员可：
- 查看用户列表  
- 查看邮箱验证状态  
- 设置为会员并设定到期时间  
- 延长会员有效期（+30/+90/+365 天）  
- 冻结 / 解冻账号  
- 删除用户（逻辑删除）  

用户字段包含：
- email_verified  
- email_verification_date  
- member_expire_at  
- role  

### 6.4 权限管理
- 查看权限  
- 分配权限  
- 支持扩展  

### 6.5 评论管理
- 查看评论  
- 按用户/文章筛选  
- 删除评论（软删除）  

---

## 7. 业务规则

### 7.1 会员有效期
```
if now > expire_at:
    用户视为会员已过期
```

### 7.2 文章内容显示
```
if admin:
    full

if visibility == hidden:
    deny

if visibility == public:
    full

if visibility == members_only:
    if active_member:
        full
    else:
        preview
```

### 7.3 评论前置条件
```
if not logged_in: 禁止  
if not email_verified: 禁止  
```

---

## 8. 非功能性需求
- 深浅色主题适配一致  
- 权限控制安全严谨  
- 前后台统一体验  
- 响应式布局适配多终端  
- 内容不可越权访问  

---

## 9. 后续扩展功能
- 标签分类  
- 点赞收藏  
- 搜索功能  
- 多语言  
- 单篇付费模式  
